<!DOCTYPE html>
<html>
   <head>
      <!-- AutobahnJS client library -->
      <script src="http://autobahn.s3.amazonaws.com/js/autobahn.min.js"></script>

      <script>

         // Tavendo WebMQ WebSocket/WAMP URL - this gets filled from Flask
         var wsuri = "{{ server }}";

         // The topic we use - this gets filled from Flask
         var topic = "{{ topic }}"

         // will hold our WAMP client session
         var session = null;

         window.onload = function() {
            // connect upon window load
            connect();
         };

         function connect() {

            // connect to WebMQ
            ab.connect(wsuri,

               // called when connection has been established
               function (sess) {
                  log("connected", wsuri);
                  session = sess;
                  onConnect0();
               },

               // called when connection was lost, failed or on reconnects
               function (code, reason, detail) {
                  log("connection lost", code, reason, detail);
               }
            );
         }

         // authenticate as "anonymous"
         function onConnect0() {
            session.authreq().then(function () {
               session.auth().then(onAuth, log);
            }, log);
         }

         // we are now authenticated
         function onAuth(permissions) {
            log("authenticated", permissions);
            session.subscribe(topic, onMyEvent);
         };

         // we received an event
         function onMyEvent(topic, event) {
            log("event", topic, event);
         };

         function log() {
            var l = document.getElementById("evts")
            for (var i = 0; i < arguments.length; ++i) {
               if (i > 0) {
                  l.innerHTML += ", ";
               }
               l.innerHTML += JSON.stringify(arguments[i]);
            }
            l.innerHTML += "\n";
         };
      </script>
   </head>
   <body>
      <h1>Push to browsers via Tavendo WebMQ from Python/Flask</h1>
      <pre id="evts" style="background-color: #333; color: #fff; width: 100%; font-size: 11px; padding: 12px; min-height: 300px;"></pre>
   </body>
</html>
